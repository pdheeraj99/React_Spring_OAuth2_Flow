# 09 - Step 6: Using the Tokens

> ğŸ“Œ You have the tokens! Now what?

---

## ğŸ¯ What Tokens Do You Have?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR TOKEN INVENTORY                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   After Step 5, you have:                                                    â”‚
â”‚                                                                              â”‚
â”‚   1. access_token                                                            â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚      Format: "ya29.a0AWY7Ckl5HqX..."                                         â”‚
â”‚      Type: Opaque (not JWT)                                                  â”‚
â”‚      Use: Call GOOGLE APIs (Drive, Photos, Gmail)                            â”‚
â”‚      Expiry: ~1 hour                                                         â”‚
â”‚                                                                              â”‚
â”‚   2. id_token                                                                â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚      Format: "eyJhbGciOiJSUzI1..." (JWT!)                                    â”‚
â”‚      Type: JWT (can be decoded)                                              â”‚
â”‚      Use: Know WHO the user is                                               â”‚
â”‚      Expiry: ~1 hour                                                         â”‚
â”‚                                                                              â”‚
â”‚   3. refresh_token (if requested)                                            â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚      Format: "1//0eZPg8v..."                                                 â”‚
â”‚      Use: Get new access_token when expired                                  â”‚
â”‚      Expiry: ~6 months                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Three Ways to Use Tokens

### Use Case 1: Just Login (Our Main Use Case!)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USE CASE 1: JUST LOGIN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Goal: Know who the user is, show their name/email                          â”‚
â”‚                                                                              â”‚
â”‚   What you use: id_token (JWT)                                               â”‚
â”‚                                                                              â”‚
â”‚   Spring extracts from id_token:                                             â”‚
â”‚   â€¢ sub: "112416036337094439562" â†’ Unique user ID                            â”‚
â”‚   â€¢ email: "dheeraj@gmail.com" â†’ User's email                                â”‚
â”‚   â€¢ name: "Dheeraj" â†’ User's name                                            â”‚
â”‚   â€¢ picture: "https://..." â†’ Profile picture URL                             â”‚
â”‚                                                                              â”‚
â”‚   Creates: OidcUser object stored in SecurityContext                         â”‚
â”‚                                                                              â”‚
â”‚   Code:                                                                      â”‚
â”‚   @GetMapping("/dashboard")                                                  â”‚
â”‚   public String dashboard(@AuthenticationPrincipal OidcUser user) {          â”‚
â”‚       return "Welcome, " + user.getFullName();                               â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚   access_token: NOT USED! (We don't call Google APIs)                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Use Case 2: Call Google APIs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USE CASE 2: GOOGLE APIS                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Goal: Access user's Google Drive, Photos, Calendar, etc.                   â”‚
â”‚                                                                              â”‚
â”‚   What you use: access_token                                                 â”‚
â”‚                                                                              â”‚
â”‚   Request:                                                                   â”‚
â”‚   GET https://www.googleapis.com/drive/v3/files                              â”‚
â”‚   Authorization: Bearer ya29.a0AWY7Ckl5HqX...                                â”‚
â”‚                                                                              â”‚
â”‚   Google checks the access_token and returns the files!                      â”‚
â”‚                                                                              â”‚
â”‚   Code:                                                                      â”‚
â”‚   @GetMapping("/my-drive-files")                                             â”‚
â”‚   public List<File> getDriveFiles(                                           â”‚
â”‚       @RegisteredOAuth2AuthorizedClient("google") OAuth2AuthorizedClient c) {â”‚
â”‚                                                                              â”‚
â”‚       String accessToken = c.getAccessToken().getTokenValue();               â”‚
â”‚                                                                              â”‚
â”‚       return webClient.get()                                                 â”‚
â”‚           .uri("https://www.googleapis.com/drive/v3/files")                  â”‚
â”‚           .header("Authorization", "Bearer " + accessToken)                  â”‚
â”‚           .retrieve()                                                        â”‚
â”‚           .bodyToMono(DriveFilesResponse.class)                              â”‚
â”‚           .block()                                                           â”‚
â”‚           .getFiles();                                                       â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Use Case 3: Send to Your Resource Server

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USE CASE 3: YOUR RESOURCE SERVER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Goal: Call your own protected APIs (our architecture!)                     â”‚
â”‚                                                                              â”‚
â”‚   What you use: id_token (JWT)                                               â”‚
â”‚                                                                              â”‚
â”‚   Flow:                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     id_token    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚ Client App  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Resource Server â”‚                        â”‚
â”‚   â”‚  (:8080)    â”‚                 â”‚    (:8081)      â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                           â”‚                                  â”‚
â”‚                                           â–¼                                  â”‚
â”‚                                   Validate JWT:                              â”‚
â”‚                                   â€¢ Signature (Google's public key)          â”‚
â”‚                                   â€¢ Expiry (exp claim)                       â”‚
â”‚                                   â€¢ Issuer (accounts.google.com)             â”‚
â”‚                                           â”‚                                  â”‚
â”‚                                           â–¼                                  â”‚
â”‚                                   Return protected data!                     â”‚
â”‚                                                                              â”‚
â”‚   Client App code:                                                           â”‚
â”‚   @GetMapping("/api/protected-data")                                         â”‚
â”‚   public Data getProtectedData(@AuthenticationPrincipal OidcUser user) {     â”‚
â”‚       String idToken = user.getIdToken().getTokenValue();                    â”‚
â”‚                                                                              â”‚
â”‚       return webClient.get()                                                 â”‚
â”‚           .uri("http://localhost:8081/api/data")                             â”‚
â”‚           .header("Authorization", "Bearer " + idToken)                      â”‚
â”‚           .retrieve()                                                        â”‚
â”‚           .bodyToMono(Data.class)                                            â”‚
â”‚           .block();                                                          â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Token Usage Summary

| Use Case | Token Used | Sent To |
|----------|------------|---------|
| Just login (show user info) | id_token | Nowhere (extracted locally) |
| Call Google APIs | access_token | Google APIs |
| Call your Resource Server | id_token (JWT) | Your Resource Server |

---

## ğŸ’¾ Where Are Tokens Stored?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOKEN STORAGE IN SPRING                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Spring stores tokens in:                                                   â”‚
â”‚                                                                              â”‚
â”‚   1. SecurityContext (current request)                                       â”‚
â”‚      â†’ OidcUser with id_token claims                                         â”‚
â”‚                                                                              â”‚
â”‚   2. OAuth2AuthorizedClientRepository (session-based)                        â”‚
â”‚      â†’ Access token, refresh token                                           â”‚
â”‚      â†’ Used for calling APIs                                                 â”‚
â”‚                                                                              â”‚
â”‚   3. HttpSession (server side!)                                              â”‚
â”‚      â†’ All of the above persisted in session                                 â”‚
â”‚      â†’ JSESSIONID cookie links browser to session                            â”‚
â”‚                                                                              â”‚
â”‚   â­ TOKENS NEVER GO TO BROWSER!                                             â”‚
â”‚   Browser only has JSESSIONID cookie, not the actual tokens!                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ User Experience After Login

```
After Step 6, user sees:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PhotoBackup Dashboard                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”                                                                   â”‚
â”‚   â”‚  ğŸ‘¤  â”‚  Welcome back, Dheeraj!                                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜  dheeraj@gmail.com                                                â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  Your backups are up to date!                                       â”‚    â”‚
â”‚   â”‚  Last backup: Today, 2:30 PM                                        â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚   [Backup Now]  [Settings]  [Logout]                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The name and email came from id_token!
```

---

## ğŸ¤” Beginner Check

1. Which token contains the user's email?
2. Which token do you send to Google Drive API?
3. Which token do you send to YOUR Resource Server?
4. Where are tokens stored? (Browser or Server?)

Answers:

1. id_token (JWT payload)
2. access_token
3. id_token (JWT)
4. Server! (HttpSession)

---

**Next:** [10_Security_Deep_Dive.md](./10_Security_Deep_Dive.md)
