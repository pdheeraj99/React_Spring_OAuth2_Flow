# Complete OAuth2 BFF Flow

> ğŸ“ **End-to-End with All Diagrams**

---

## ğŸ¯ Master Sequence Diagram

```
  BROWSER            BFF (8080)          GOOGLE              RESOURCE
  (React)                                                    SERVER (8081)
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘  Click Login      â”‚                   â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘¡ Redirect to Google                   â”‚                    â”‚
    â”‚â—„â”€â”€â”€â”€ 302 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘¢ Go to Google Login Page              â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚        [User enters credentials]       â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘£ Google redirects with code           â”‚                    â”‚
    â”‚â—„â”€â”€â”€â”€ 302 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘¤ Browser follows redirect             â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                    â”‚
    â”‚   /login/oauth2/code/google?code=...   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘¥ Exchange code   â”‚                    â”‚
    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
    â”‚                    â”‚   POST /token     â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘¦ Tokens returned â”‚                    â”‚
    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                    â”‚   {access_token,  â”‚                    â”‚
    â”‚                    â”‚    id_token}      â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘§ Save to session â”‚                    â”‚
    â”‚                    â”‚   [INTERNAL]      â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘¨ Redirect to dashboard                â”‚                    â”‚
    â”‚â—„â”€â”€â”€â”€ 302 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
    â”‚   + Set-Cookie     â”‚                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘© Show dashboard   â”‚                   â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€[render]â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘ª Click "Get Photos"                   â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                    â”‚
    â”‚   GET /api/photos  â”‚                   â”‚                    â”‚
    â”‚   Cookie: JSESSIONID                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘« Get JWT from session                 â”‚
    â”‚                    â”‚   [INTERNAL]      â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘¬ Call with JWT   â”‚                    â”‚
    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                    â”‚   Authorization: Bearer <JWT>          â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚ â‘­ Validate JWT     â”‚
    â”‚                    â”‚                   â”‚   [JWKS lookup]    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚                    â”‚ â‘® Return photos   â”‚                    â”‚
    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘¯ Return photos    â”‚                   â”‚                    â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚
    â”‚ â‘° Display photos   â”‚                   â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€[render]â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
    â”‚                    â”‚                   â”‚                    â”‚

```

---

## ğŸ“Š Phase-by-Phase Breakdown

### Phase 1: OAuth Initiation (Steps 1-3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: LOGIN INITIATION                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  BROWSER                          BFF                             GOOGLE    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€                             â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                              â”‚
â”‚  â‘  User clicks "Sign in with Google"                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     <a href="http://localhost:8080/oauth2/authorization/google">            â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘¡ BFF receives request, generates state, redirects                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚     Filter: OAuth2AuthorizationRequestRedirectFilter                        â”‚
â”‚     â€¢ Generate state=XMwoJXG0...                                            â”‚
â”‚     â€¢ Generate nonce=XMwoJXG0...                                            â”‚
â”‚     â€¢ Save auth request in session                                          â”‚
â”‚     â€¢ Build Google URL                                                      â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚     HTTP 302                                                                 â”‚
â”‚     Location: https://accounts.google.com/o/oauth2/v2/auth?                 â”‚
â”‚       response_type=code&                                                    â”‚
â”‚       client_id=450472639030-...&                                           â”‚
â”‚       scope=openid+email+profile&                                           â”‚
â”‚       state=XMwoJXG0...&                                                    â”‚
â”‚       redirect_uri=http://localhost:8080/login/oauth2/code/google           â”‚
â”‚     Set-Cookie: JSESSIONID=440421F8...                                      â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘¢ Browser redirects to Google                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚     User sees Google login page                                             â”‚
â”‚     User enters credentials/selects account                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Phase 2: Token Exchange (Steps 4-8)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: CALLBACK & TOKEN EXCHANGE                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  GOOGLE                           BFF                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€                           â”€â”€â”€                                        â”‚
â”‚                                                                              â”‚
â”‚  â‘£ Google redirects back with code                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     HTTP 302                                                                 â”‚
â”‚     Location: http://localhost:8080/login/oauth2/code/google?               â”‚
â”‚       code=4/0AQSTgQF8Jhq7kN2X...&                                          â”‚
â”‚       state=XMwoJXG0...&                                                    â”‚
â”‚       scope=email+profile+openid                                            â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘¤ Browser follows redirect to BFF                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     GET /login/oauth2/code/google?code=...&state=...                        â”‚
â”‚     Cookie: JSESSIONID=440421F8...                                          â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘¥-â‘¦ BFF exchanges code for tokens (SERVER-TO-SERVER!)                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚     Filter: OAuth2LoginAuthenticationFilter                                 â”‚
â”‚                                                                              â”‚
â”‚     â”‚  POST https://oauth2.googleapis.com/token                             â”‚
â”‚     â”‚  Content-Type: application/x-www-form-urlencoded                      â”‚
â”‚     â”‚  Body:                                                                â”‚
â”‚     â”‚    grant_type=authorization_code&                                     â”‚
â”‚     â”‚    code=4/0AQSTgQF8Jhq7kN2X...&                                       â”‚
â”‚     â”‚    redirect_uri=http://localhost:8080/login/oauth2/code/google&       â”‚
â”‚     â”‚    client_id=450472639030-...&                                        â”‚
â”‚     â”‚    client_secret=GOCSPX-...                                           â”‚
â”‚     â”‚                                                                        â”‚
â”‚     â”‚â—„â”€â”€â”€ RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚     â”‚  {                                                                    â”‚
â”‚     â”‚    "access_token": "ya29.a0ARW5m7...",                               â”‚
â”‚     â”‚    "id_token": "eyJhbGciOiJSUzI1NiIs...",                            â”‚
â”‚     â”‚    "expires_in": 3599,                                                â”‚
â”‚     â”‚    "token_type": "Bearer"                                             â”‚
â”‚     â”‚  }                                                                    â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘§ Save tokens to session                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚     session.setAttribute("SPRING_SECURITY_CONTEXT", {                       â”‚
â”‚       authentication: OAuth2AuthenticationToken {                           â”‚
â”‚         principal: OidcUser { name, email, picture, idToken }              â”‚
â”‚       }                                                                     â”‚
â”‚     });                                                                     â”‚
â”‚                                                                              â”‚
â”‚     session.setAttribute("oauth2AuthorizedClient_google", {                 â”‚
â”‚       accessToken: "ya29.a0...",                                           â”‚
â”‚       refreshToken: null                                                    â”‚
â”‚     });                                                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Phase 3: Dashboard Load (Steps 9-10)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: REDIRECT TO DASHBOARD                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  BFF                              BROWSER                                    â”‚
â”‚  â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€                                    â”‚
â”‚                                                                              â”‚
â”‚  â‘¨ BFF sends redirect to React                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     HTTP 302                                                                 â”‚
â”‚     Location: http://localhost:5173/dashboard                               â”‚
â”‚     Set-Cookie: JSESSIONID=440421F8...                                      â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘© Browser loads React dashboard                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     React calls /api/user-status                                            â”‚
â”‚     BFF returns: { authenticated: true, name: "Dheeraj", ... }             â”‚
â”‚     React displays user info                                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Phase 4: Protected Resource Access (Steps 11-17)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4: ACCESSING PROTECTED RESOURCE                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  BROWSER          BFF                                  RESOURCE SERVER       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€                                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                                                              â”‚
â”‚  â‘ª User clicks "Get My Photos"                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚     GET /api/photos                                                          â”‚
â”‚     Cookie: JSESSIONID=440421F8...                                          â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘«-â‘¬ BFF extracts JWT, calls Resource Server                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     JWT = session.user.idToken.tokenValue                                   â”‚
â”‚                    â”‚                                                         â”‚
â”‚     â”‚  GET /photos                                                          â”‚
â”‚     â”‚  Authorization: Bearer eyJhbGciOiJSUzI1NiIs...                       â”‚
â”‚     â”‚                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚                                     â”‚                                        â”‚
â”‚  â‘­ Resource Server validates JWT   â”‚                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚                                     â”‚ 1. Extract JWT from header            â”‚
â”‚                                     â”‚ 2. Decode header â†’ get kid            â”‚
â”‚                                     â”‚ 3. Fetch JWKS from Google             â”‚
â”‚                                     â”‚ 4. Verify signature                   â”‚
â”‚                                     â”‚ 5. Validate claims (iss, aud, exp)    â”‚
â”‚                                     â”‚ 6. Extract user from payload          â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚                                                                              â”‚
â”‚  â‘® Resource Server returns photos                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚     HTTP 200 OK                                                              â”‚
â”‚     Content-Type: text/html                                                  â”‚
â”‚     Body: <h1>Welcome Dheeraj!</h1>...                                      â”‚
â”‚                    â”‚                                                         â”‚
â”‚                    â–¼                                                         â”‚
â”‚                                                                              â”‚
â”‚  â‘¯-â‘° BFF returns to browser, React displays                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚     HTTP 200 OK                                                              â”‚
â”‚     Body: Photos HTML                                                        â”‚
â”‚     React renders photos ğŸ‰                                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Summary

### What's in Browser?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BROWSER STORAGE                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Cookies:                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JSESSIONID = 440421F81FB0CD37C26E757DADE4CBAB                       â”‚   â”‚
â”‚  â”‚ (HttpOnly = JavaScript cannot read)                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  âŒ NO Access Token                                                         â”‚
â”‚  âŒ NO ID Token (JWT)                                                       â”‚
â”‚  âŒ NO user data in localStorage                                            â”‚
â”‚  âŒ NO sensitive data exposed                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What's in Server Session?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVER SESSION (RAM)                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  SPRING_SECURITY_CONTEXT:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ OAuth2AuthenticationToken                                           â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ principal: OidcUser { name, email, picture, idToken }          â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ authorities: [OIDC_USER, SCOPE_email, SCOPE_profile]           â”‚   â”‚
â”‚  â”‚ â””â”€â”€ authenticated: true                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  oauth2AuthorizedClient_google:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ accessToken: "ya29.a0ARW5m7..."                                     â”‚   â”‚
â”‚  â”‚ refreshToken: null                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Quick Reference Card

| Component | Port | Purpose |
|-----------|------|---------|
| React UI | 5173/5174 | User interface |
| Client Backend (BFF) | 8080 | OAuth handling, token storage |
| Resource Server | 8081 | Protected API, JWT validation |
| Google OAuth | N/A | Authentication provider |

| URL | Who Handles | Action |
|-----|-------------|--------|
| `/oauth2/authorization/google` | OAuth2AuthorizationRequestRedirectFilter | Redirect to Google |
| `/login/oauth2/code/google` | OAuth2LoginAuthenticationFilter | Token exchange |
| `/api/*` | Controller | Business logic |
| `/logout` | LogoutFilter | Clear session |

| Session Key | Contains | Access Via |
|-------------|----------|------------|
| SPRING_SECURITY_CONTEXT | User + ID Token | @AuthenticationPrincipal |
| oauth2AuthorizedClient | Access Token | @RegisteredOAuth2AuthorizedClient |

---

## ğŸ“ Key Learnings

1. **BFF Pattern** - Tokens never reach browser
2. **Session = Server RAM** - JSESSIONID is just a key
3. **OAuth2 + JWT** - OAuth2 is protocol, JWT is token format
4. **Two Token Types** - Access Token (opaque), ID Token (JWT)
5. **Filter Chain** - 17 filters process every request
6. **State Parameter** - CSRF protection for OAuth
7. **JWKS** - Public key for JWT signature verification

---

> ğŸ‰ **Congratulations!** You now have complete mastery of OAuth2 BFF pattern!
